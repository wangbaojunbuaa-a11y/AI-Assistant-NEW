name: Build Windows Exe

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build with PyInstaller
      shell: pwsh
      run: |
        pyinstaller AI-Work-Assistant.spec
        if ($LASTEXITCODE -ne 0) {
            Write-Error "PyInstaller build failed"
            exit $LASTEXITCODE
        }

    - name: List build output
      shell: pwsh
      run: |
        Write-Output "Listing dist directory:"
        if (Test-Path dist) {
            Get-ChildItem dist -Recurse | Select-Object FullName, Length
        } else {
            Write-Output "dist directory not found"
        }

    - name: Prepare Release Artifacts
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release
        if (Test-Path "dist\AI-Work-Assistant.exe") {
            Copy-Item -Path "dist\AI-Work-Assistant.exe" -Destination "release\"
            Write-Output "EXE file copied successfully"
        } else {
            Write-Output "WARNING: AI-Work-Assistant.exe not found, but continuing..."
        }

    - name: Copy required directories
      shell: pwsh
      run: |
        if (Test-Path web) {
            Copy-Item -Path web -Destination "release\web" -Recurse -Force
            Write-Output "web folder copied"
        }
        if (Test-Path config) {
            Copy-Item -Path config -Destination "release\config" -Recurse -Force
            Write-Output "config folder copied"
        }
        if (Test-Path 工具库) {
            Copy-Item -Path 工具库 -Destination "release\工具库" -Recurse -Force
            Write-Output "工具库 folder copied"
        }
        if (Test-Path 通用操作守则) {
            Copy-Item -Path 通用操作守则 -Destination "release\通用操作守则" -Recurse -Force
            Write-Output "通用操作守则 folder copied"
        }
        if (Test-Path catalog_template.xlsx) {
            Copy-Item -Path catalog_template.xlsx -Destination "release\"
            Write-Output "catalog_template.xlsx copied"
        }

    - name: List release directory
      shell: pwsh
      run: |
        Write-Output "Release directory contents:"
        if (Test-Path release) {
            Get-ChildItem release -Recurse | Select-Object FullName, Length
        } else {
            Write-Output "release directory not found"
        }

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: AI-Work-Assistant-Windows
        path: release/
